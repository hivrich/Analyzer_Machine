# Analyzer Machine — Rules: точный анализ метрик (Traffic vs Conversion)

Этот документ задаёт строгие правила, по которым Analyzer Machine:
- запрашивает данные,
- считает изменения и вклады,
- отделяет «проблему трафика» от «проблемы конверсии»,
- формирует отчёт (при необходимости — с 1 вызовом LLM).

Цель документа — **воспроизводимость и доказуемость**: любые цифры в отчёте должны быть проверяемы по сохранённым JSON‑ответам API и рассчитанным агрегатам.

---

## 0) Инварианты (обязательные правила)

1) **Никакой арифметики “в голове”**  
   Все дельты, вклады, топы, рейтинги, группировки — только кодом.

2) **Никаких выдуманных данных**  
   Любая цифра в тексте должна быть:
   - либо из raw JSON ответа API,
   - либо вычислена кодом из raw JSON,
   - и иметь трассировку (какой файл кэша / какие поля использованы).

3) **LLM не считает**  
   LLM (если включён) получает только **готовые агрегаты** (итоги, дельты, вклады, топ‑N), и делает:
   - формулировку выводов,
   - ранжирование гипотез,
   - чек‑лист проверок.
   LLM не должен вычислять проценты/дельты/суммы.

4) **Кэш обязателен**  
   Все сырые ответы API сохраняются в `data_cache/<client>/...raw...json`.  
   Все нормализованные/агрегированные структуры — в `data_cache/<client>/...norm|agg...json`.  
   Повторный запуск анализа должен уметь работать из кэша.

5) **Безопасность**  
   Токены, ключи, credentials:
   - не логируются,
   - не печатаются,
   - не попадают в git.

---

## 1) Строгое разделение: Traffic vs Conversion

### 1.1 Traffic (трафик)
**Определение:** метрики объёма и качества посещений.

Типовые метрики (сессии):
- `visits` — визиты
- `users` — пользователи
- `bounceRate` — отказность (%)
- `pageDepth` — глубина просмотра
- `avgVisitDurationSeconds` — длительность визита (сек)

Traffic‑анализ отвечает на вопросы:
- Где упал/вырос объём?
- Какие источники/страницы дали основной вклад?
- Изменилось ли качество трафика (bounce/depth/duration)?

### 1.2 Conversion (конверсия)
**Определение:** метрики достижения целевого действия и/или денег.

MVP‑определение конверсии (рекомендуется):
- `goal_visits` = `ym:s:goal<goal_id>visits` (конверсионные визиты по ключевой цели)
- `goal_cr` = `ym:s:goal<goal_id>conversionRate` (%)

Если в проекте включён ecommerce (позже), добавляются:
- `transactions` / `revenue` / `aov` (с отдельной валидацией метрик и методики).

Conversion‑анализ отвечает на вопросы:
- Конверсия (CR) изменилась сама по себе или только из‑за трафика?
- Где “сломалась” эффективность (источники / входные страницы)?
- Если есть деньги: что произошло с выручкой и средним чеком?

### 1.3 Связь Traffic ↔ Conversion
Базовая декомпозиция:
- Выручка ≈ Трафик × Конверсия × Средний чек (если есть AOV)
- Конверсионные визиты ≈ Визиты × CR (для goal‑конверсии)

В отчётах обязательно фиксируем, **какая часть изменения результата обусловлена объёмом**, а **какая — эффективностью**.

---

## 2) Периоды сравнения (как выбирать «предыдущий период»)

Analyzer Machine поддерживает минимум два режима сравнения:

1) **prev_period** — предыдущий период той же длины (back‑to‑back)  
   Пример: текущий 2025‑12‑18…2025‑12‑24 (7 дней), предыдущий 2025‑12‑11…2025‑12‑17.

2) **yoy** — тот же период год назад  
   Пример: 2024‑12‑18…2024‑12‑24.

Правило:
- длина периода сравнения должна совпадать,
- границы периода считает код (не пользователь),
- в отчёте всегда выводим явные даты обоих периодов.

---

## 3) Формулы дельт (изменения между периодами)

### 3.1 Абсолютная дельта
```
abs_delta = current - previous
```

### 3.2 Относительная дельта (%)
```
rel_delta_pct = (current - previous) / previous * 100
```

### 3.3 Нулевые значения (защита от деления на ноль)
Если `previous == 0`:
- если `current == 0`: `rel_delta_pct = 0`
- если `current > 0`: `rel_delta_pct = +∞` (в отчёте писать как “рост с 0”, без процентов)
- если `current < 0`: это невозможно для счётчиков; трактовать как ошибка данных.

---

## 4) Формулы вкладов (contribution)

Вклад нужен, чтобы ответить «что именно дало основное падение/рост» по источникам/страницам.

### 4.1 Вклад строки (источник/страница) в абсолютную дельту
Для каждой строки i:
```
row_abs_delta_i = row_current_i - row_previous_i
```

### 4.2 Доля вклада строки (% от общей абсолютной дельты)
Пусть:
```
total_abs_delta = total_current - total_previous
```
Тогда для строки i:
```
row_contrib_pct_i = row_abs_delta_i / total_abs_delta * 100
```

Правила интерпретации:
- рассчитывать долю вклада **только если |total_abs_delta| достаточно велик** (иначе проценты будут шумными);
- если `total_abs_delta` близок к нулю — показывать только `row_abs_delta_i` и ранжирование.

### 4.3 Топ‑N по отрицательному/положительному вкладу
- Топ причин падения: сортировка по `row_abs_delta_i` (по возрастанию, самые отрицательные первые)
- Топ причин роста: сортировка по `row_abs_delta_i` (по убыванию)

---

## 5) Конверсионные метрики (goal‑MVP)

### 5.1 Конверсионные визиты и CR
- `conv_visits` = `goal_visits`
- `cr_pct` = `goal_cr`

Важно:
- `goal_cr` в Метрике обычно выражен в процентах (не доля). В расчётах в коде фиксировать единицы.

### 5.2 Производные показатели (для отчёта)
- Конверсионные визиты на 1000 визитов:
```
conv_per_1000 = goal_visits / visits * 1000
```
(если `visits > 0`)

---

## 6) Критерии классификации: «проблема трафика» vs «проблема конверсии»

Мы классифицируем ситуацию по **одному и тому же сравнимому периоду** (prev_period или yoy) и по ключевой цели.

Обозначения:
- `ΔV%` — относительная дельта визитов
- `ΔCR%` — относительная дельта CR по цели
- `ΔCV` — абсолютная дельта конверсионных визитов (goal_visits)

### 6.1 Основные классы (MVP)

1) **Traffic‑issue (трафик)**  
   Условия (типовой случай):
   - `ΔV%` существенно отрицательная,
   - `ΔCR%` около нуля (в пределах шума/базового диапазона),
   - `ΔCV` падает главным образом из‑за падения V.  
   Действие: декомпозиция по источникам и входным страницам, проверка SEO/видимости/каналов.

2) **Conversion‑issue (конверсия)**  
   Условия:
   - `ΔV%` около нуля,
   - `ΔCR%` существенно отрицательная,
   - `ΔCV` падает при стабильном V.  
   Действие: анализ входных страниц, качества трафика, UX/воронки/технических ошибок.

3) **Mixed (смешанная)**  
   Условия:
   - и `ΔV%`, и `ΔCR%` существенно отрицательные.  
   Действие: параллельная декомпозиция трафика (где упало) и конверсии (где просела эффективность).

4) **Positive shift (улучшение)**  
   Условия:
   - `ΔV%` и/или `ΔCR%` существенно положительные.  
   Действие: найти источники/страницы роста, закрепить гипотезы.

### 6.2 Что значит «существенно» (порог/базовая линия)

Приоритет правил:
1) **Baseline клиента** (если доступен)  
2) **Порог из `clients/<client>/config.yaml`** (если задан)  
3) **Дефолты проекта** (как запасной вариант)

---

## 7) Пороги и baseline (без “универсальных норм”)

### 7.1 Почему нельзя опираться только на “универсальные нормы”
Bounce/pageDepth/CR сильно зависят от:
- источника,
- типа страниц (контент/коммерция),
- устройства,
- сезонности,
- региональности.

Поэтому абсолютные “нормы” допустимы только как **fallback**, а основной механизм — сравнение:
- с предыдущим периодом,
- с baseline клиента.

### 7.2 Baseline клиента (рекомендуемый MVP)
Baseline строится по N прошлым сопоставимым периодам (например, 6–8 недельных периодов):
- считаем медиану и межквартильный размах (IQR) по каждой ключевой метрике,
- считаем отклонение текущего значения от медианы.

Правило аномалии (пример):
- если метрика выходит за медиану ± K·IQR (K задаётся в конфиге), считаем это сигналом.

Если baseline пока не реализован, используем пороги из 7.3.

### 7.3 Дефолтные пороги (fallback, для MVP)
Эти пороги применяются только если **нет** baseline и **нет** переопределений в конфиге.

Трафик:
- `visits/users`:
  - критично: падение ≥ 30% за сравнимый период
  - существенно: падение 15–30%
  - предупреждение: падение 10–15%

Конверсия (goal):
- `goal_cr`:
  - критично: падение ≥ 25%
  - существенно: падение 15–25%
  - предупреждение: падение 10–15%

Качество трафика (fallback‑эвристики):
- `bounceRate`: рост на ≥ 10 п.п. за период → сигнал (при стабильном V)
- `pageDepth`: падение на ≥ 15% → сигнал
- `avgVisitDurationSeconds`: падение на ≥ 15% → сигнал

### 7.4 Переопределение порогов в конфиге клиента
Рекомендуемый блок в `clients/<client>/config.yaml`:
- `thresholds.traffic.*`
- `thresholds.conversion.*`
- `thresholds.quality.*`
- `baseline.*`

Правило: если значение задано в конфиге — оно имеет приоритет над дефолтом.

---

## 8) Семплирование и точность (sampling/accuracy)

Reporting API может использовать выборку в зависимости от объёма данных и параметра `accuracy`.
Правила:
1) Analyzer Machine обязан **сохранять** в кэше:
   - какие параметры точности были запрошены (`accuracy`),
   - и любую доступную в ответе информацию о выборке (если API её возвращает).
2) В отчёте обязательно указывать:
   - режим точности запроса,
   - и предупреждение, если данные потенциально семплированы.
3) Если вывод «на грани» (близко к порогам) — рекомендовать перезапуск анализа с более высокой точностью (`high/full`).

---

## 9) Принцип 1 LLM call на отчёт

### 9.1 Правило
- Один вызов LLM на один отчёт.
- В LLM передаются только агрегаты (totals/deltas/contributions/top‑N), **не raw**.

### 9.2 Структура отчёта (Markdown)
1) Executive Summary
2) Traffic: totals + deltas + top вкладов по источникам и страницам
3) Conversion: totals + deltas + топ вкладов по источникам и страницам (если доступно)
4) Классификация проблемы (Traffic / Conversion / Mixed) с объяснением по правилам раздела 6
5) Гипотезы (ограниченное число, привязанные к наблюдениям)
6) Checklist проверок (технические / SEO / UX)
7) Приложение: файлы кэша и параметры запросов

### 9.3 Формат входа для LLM (агрегаты)
Рекомендуемый JSON‑пакет:
- metadata (client, counter_id, dates, compare_mode, requested_accuracy, sampling_info_if_any)
- totals_current / totals_previous
- deltas (abs + rel)
- contributions:
  - sources_top_neg, sources_top_pos
  - landing_pages_top_neg, landing_pages_top_pos
- conversion_totals (goal_visits, goal_cr) + deltas
- quality_signals (bounce/depth/duration deltas)
- thresholds_used (из baseline/конфига/дефолта)

### 9.4 Промпт‑правила для LLM (кратко)
- не считать цифры, не пересчитывать проценты;
- выводы только на основе входных агрегатов;
- если данных недостаточно — явно указать, каких разрезов/запросов не хватает.

---

## 10) Примеры (минимум)

### 10.1 Дельта визитов
- abs: `V_cur - V_prev`
- rel%: `(V_cur - V_prev) / V_prev * 100` (если `V_prev > 0`)

### 10.2 Вклад источника в падение визитов
- `row_abs_delta_i = visits_i_cur - visits_i_prev`
- сортировка по `row_abs_delta_i` (самые отрицательные — главные причины падения)

### 10.3 Классификация
Если:
- `ΔV% = -28%`,
- `ΔCR% = -2%` (в пределах шума/порогов),
то класс: **Traffic‑issue**.

---

## 11) Ссылки
Ссылки на официальную документацию держим в репозитории отдельно (README/Docs), чтобы не “протухали” в теле правил.
