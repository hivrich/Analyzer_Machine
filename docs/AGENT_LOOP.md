# Analyzer Machine — Agent Loop Standard (Cursor)

## Цель
Обеспечить воспроизводимый, доказательный анализ трафика/конверсий/SEO:
- запросы → кэш → расчёты кодом → компактные workbook → интерпретация LLM → отчёт
- без выдуманных цифр, без ручной арифметики, без самовольных правок кода во время “прогона”

## Термины
- Run: один запуск анализа по пользовательскому запросу (один кейс).
- Evidence pack: набор файлов кэша + workbook + лог/вывод, на которые опирается отчёт.
- Capability: реализованная в коде возможность получить/посчитать конкретный срез (sources, landing pages, ecommerce, goals…).

## Вход от пользователя (человеческий язык)
Пользователь формулирует задачу естественным языком, например:
“Проверь падение трафика и конверсии 01–25 Dec 2025 vs 01–25 Dec 2024, найди драйверы и гипотезы.”

## Жёсткие правила (must)
1) Никаких цифр без источника: каждая цифра в отчёте должна быть получена из:
   - вывода CLI
   - workbook JSON
   - raw/norm кэша
2) Все расчёты делаются кодом, не “в голове” и не LLM.
3) Во время Run запрещено менять базовые файлы проекта (app/*, docs/*, requirements.txt),
   кроме случаев “Capability missing” (см. ниже).
4) Секреты не выводить и не писать в репозиторий.
5) LLM используется только:
   - для планирования шагов (что запросить/проверить) на основе доступных capabilities
   - для написания текста отчёта по компактному workbook

## Алгоритм Run (итеративно, но контролируемо)
### Шаг A. Intake → формализация
- определить client
- определить периоды и сравнения
- определить KPI (трафик, ecommerce, цели и т.д.)
- определить бюджет: максимум запросов к API и максимум LLM-вызовов

### Шаг B. Baseline pull (минимальный набор)
- выполнить существующие команды CLI для получения ключевых срезов
- принудительно обновить кэш, если пользователь просит “актуально”

### Шаг C. Compute (только код)
- выполнить команды сравнения (дельты/вклады/top drivers)
- сохранить workbook

### Шаг D. Decide (нужна ли доп. информация)
- если драйверы не объясняют кейс: выбрать следующий срез (landing pages / campaigns / geo / devices / new vs returning / ecommerce)
- повторить B–C для дополнительных срезов (ограничено бюджетом)

### Шаг E. Report (LLM только по workbook)
Отчёт обязан содержать:
- Executive summary (кратко)
- Facts (таблично/цифры) + ссылки на файлы evidence pack
- Drivers (топ вкладов + интерпретация)
- Hypotheses (5–8) + какие данные нужны для проверки каждой
- Next actions (что проверить руками / что автоматизировать дальше)

## “Capability missing” — единственный разрешённый повод менять код во время Run
Если в ходе Run выяснилось, что нужного среза/эндпоинта нет:
- НЕ делать выводы “на глаз”
- зафиксировать в отчёте секцию “Capability missing”:
  - что нужно получить (какие метрики/размерности)
  - какой API эндпоинт
  - какой новый CLI-командой это должно стать
- затем остановить Run (или продолжить только доступной частью анализа)

## Артефакты Run (структура)
- data_cache/<client>/... raw/norm/workbook
- reports/<client>/<run_id>/report.md
- reports/<client>/<run_id>/evidence.txt (пути к ключевым файлам)
