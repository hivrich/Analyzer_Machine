# Analyzer Machine — Agent Loop Standard (Cursor)

## Цель
Обеспечить воспроизводимый, доказательный анализ трафика/конверсий/SEO:
- запросы → кэш → расчёты кодом → **компактные insights** → интерпретация LLM → отчёт
- "Scripts count, LLM analyzes": тяжелые вычисления и поиск аномалий делают скрипты.

## Термины
- Run: один запуск анализа по пользовательскому запросу.
- Insight Pack: текстовая выжимка (summary) от Python-скрипта, которая показывает драйверы роста/падения и аномалии.
- Evidence pack: набор файлов кэша + workbook + лог/вывод.

## Вход от пользователя (человеческий язык)
“Проверь падение трафика и конверсии, найди драйверы.”

## Жёсткие правила (must)
1) **Всегда используй флаг `--format insights`** для команд анализа (`analyze-sources`, `analyze-pages` и т.д.).
   - Читать гигантские таблицы (ASCII tables) запрещено, если этого явно не попросил пользователь.
   - Экономим токены: Python сам найдет топ драйверов и аномалии.
2) Никаких цифр без источника.
3) Все расчёты делаются кодом.
4) **⚡ ОБЯЗАТЕЛЬНЫЙ АУДИТ:** Каждая цифра, вывод, гипотеза должны пройти проверку перед публикацией.
   - Используй `app.audit` для верификации данных.
   - Каждая гипотеза должна иметь альтернативы.
   - Confidence в выводах <50% = НЕ публиковать.
   - См. подробно: `docs/AUDIT_RULES.md`

## Алгоритм Run (Low-Token Mode)
### Шаг A. Intake
- Определить client, периоды, KPI.

### Шаг B. Smart Pull & Compute
- Выполнить команды анализа с флагом `--format insights`.
  *Пример:* `python -m app.cli analyze-sources client 2024-01-01 2024-01-31 2025-01-01 2025-01-31 --format insights`
- Скрипт выдаст:
  - Общий тренд (рост/падение).
  - Топ-3 драйвера роста.
  - Топ-3 драйвера падения.
  - Новые/потерянные источники.
  - Алерты по конверсии.

### Шаг C. ⚡ AUDIT: Data Verification (ОБЯЗАТЕЛЬНО!)
- **STOP! Проверка данных перед выводами.**
- Для каждой ключевой цифры:
  ```python
  from app.audit import AuditEngine, DataPoint
  
  engine = AuditEngine(client_name)
  result = engine.verify_data_source(DataPoint(
      metric="visits_organic",
      value=12499,
      source_file="analysis_sources_*.json",
      period="Q4 2025"
  ))
  
  if result.status == "failed":
      # НЕ использовать эту цифру!
      print(f"⚠️ Data issue: {result.issues}")
  ```
- Проверить:
  - ✅ Источник данных существует
  - ✅ Метрика есть в источнике
  - ✅ Значение совпадает
  - ✅ Нет аномалий (>300% изменений)
  - ✅ Кросс-проверка (если есть альтернативные источники)

### Шаг D. Deep Dive (только если нужно)
- Если Insight Report показал конкретную аномалию (например, "Direct traffic упал на 50%"), агент может запросить детализацию *только по этому сегменту*.
- Или прочитать сохраненный workbook JSON (но не весь, а нужную секцию).

### Шаг E. ⚡ AUDIT: Hypothesis Check (ОБЯЗАТЕЛЬНО!)
- **STOP! Проверка гипотез перед формулированием рекомендаций.**
- Для каждой гипотезы:
  ```python
  result = engine.check_hypothesis(
      hypothesis="Форма Лаборатории сломана",
      supporting_data=[...],  # минимум 3 точки данных
      context={"type": "conversion_drop", "magnitude": -40}
  )
  
  print(f"Confidence: {result.confidence:.0%}")
  print(f"Alternatives: {result.alternative_hypotheses}")
  
  if result.confidence < 0.5:
      # Гипотеза слабая, рассмотреть альтернативы!
  ```
- Обязательно:
  - Минимум 3 альтернативные гипотезы
  - Указать confidence (0-100%)
  - План проверки гипотезы
  - Учесть внешние факторы (сезонность, праздники)

### Шаг F. Report
- Написать отчет, основываясь на **проверенных** фактах из Insight Reports.
- Каждая цифра = source file указан.
- Каждая гипотеза = alternatives перечислены.
- Каждый вывод = confidence указан.

### Шаг G. ⚡ AUDIT: Final Report Check (ОБЯЗАТЕЛЬНО!)
- **STOP! Итоговая проверка отчета перед публикацией.**
- Запустить полный аудит:
  ```bash
  python -m app.audit report reports/<client>/REPORT.md --strict
  ```
- Критерии публикации:
  - ✅ Passed (confidence >80%) → публиковать
  - ⚠️ Warning (50-80%) → публиковать с оговорками
  - ❌ Failed (<50%) → НЕ публиковать, доработать

### Шаг H. Publish
- Только если аудит passed/warning.
- Добавить в отчет секцию "Audit Status" с результатами проверки.
